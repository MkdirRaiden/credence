model ReferralCode {
  // Core fields
  id          String  @id @default(uuid())
  owner       User    @relation(fields: [ownerUserId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  ownerUserId String
  code        String  @unique
  active      Boolean @default(true)

  // Optional fields for advanced features
  startsAt               DateTime?
  endsAt                 DateTime?
  maxRedemptionsPerMonth Int?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Back-reference to all redemptions of this code
  redemptions ReferralRedemption[]

  // Indexes for efficient queries
  @@index([ownerUserId])
  @@index([active, startsAt, endsAt])
}

model ReferralRedemption {
  // Core fields
  id String @id @default(uuid())

  referrer   User   @relation("Referrer", fields: [referrerId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  referrerId String

  referee   User   @relation("Referee", fields: [refereeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  refereeId String

  referralCode   ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  referralCodeId String

  status RedemptionStatus @default(PENDING)

  // Optional admin fields for approved/rejected redemptions
  reason         String?
  idempotencyKey String?

  // Timestamps
  createdAt DateTime  @default(now())
  decidedAt DateTime?

  // Back-reference to all ledger entries created from this redemption
  ledgerEntries CreditLedger[] @relation("RedemptionLedger")

  // Optional idempotency scoping to referee if you generate per-referee keys (uncomment if desired)
  // @@unique([refereeId, idempotencyKey])

  // Each referee can redeem a specific code only once
  @@unique([referralCodeId, refereeId], name: "uniq_code_referee")
  // Indexes for efficient queries
  @@index([referrerId, createdAt])
  @@index([refereeId, createdAt])
}
